## MySQL update/delete statement issue with subqueries

최근 서브쿼리에 대해 더 알아보고 싶어 Hibernate-ORM 이슈를 탐색하던 중 알맞은 이슈가 있어 기여를 하기로 했다.

[ISSUE: HHH-18040](https://hibernate.atlassian.net/browse/HHH-18040)

이슈를 분석하며 MERGE되기 까지의 회고 글([1093에러 해결](https://www.linkedin.com/feed/update/urn:li:activity:7414946017055453184/))이다.

문제는 MERGE된 후 메인테이너가 아래와 같이 댓글을 달았다.

```text
Hey @Mion, I just noticed that the MySQLDmlSubqueryTest also runs on MariaDB and before version 11.1 a self-join rewrite optimization wasn’t implemented yet, which results in the same error as on MySQL before. Would you please be so kind and look into this matter? I applied the same code change (double nesting) you did for MySQL, but unfortunately correlations don’t work.

I’ll just skip the failing tests for now, but ideally, you would find a way to make correlations works slightly smiling face 
```
`correlation`이 문제다.

당연히 MYSQL을 수정하기에 MARIADB에도 영향이 가는줄은 알았지만 확인한 바 MARIADB에서는 MYSQL과 같은 쿼리를 작성했을때 1093에러가 발생하지 않았다. 그 이유를 찾아보니 이미 11.1버전이상에서는 "referring to a table in a subquery which is the target for a delete/update" 이 문제를 해결([MDEV-7487](https://jira.mariadb.org/browse/MDEV-7487))하고 있었다.

문제는 Hibernate-ORM의 MARIADB 최소 지원 버전은 10.6 이였으며 곧 지원종료가 되지만 이후 10.11버전은 여전히 이후에도 유효하기에 11.1 버전 이전에서의 해당 이슈를 수정해야했다.

따라서 나는 메인테이너의 요구대로 어떻게 하면 11.1이전의 버전에서 해당 문제를 해결할까 고민을 하였고 여러가지 문서를 찾는 중 이미 MARIADB 10.3부터 자기 참조([What’s New in MariaDB 10.3](https://ctventures.com/whats-new-in-mariadb-10-3/))가 가능했던 것이였다. 

일단 mysql에서 사용한 select * from문으로 한번 더 감싸는 것은 mariadb에서 불가능하다. 왜냐하면 mysql은 correlation에러가 나지 않지만 mariadb는 2단계 서브쿼리 depth면 correlation에러가 나기 때문이다. mysql은 LATERAL을 지원하기에 에러가 나지 않는것 같다. 어쨋든 그렇기에 감싸는 방법이 아닌 3가지 방법을 찾았다.

### 11.1+ 버전 에뮬레이션 
결론적으로 이건 exist,in은 semi join을 통해 비교적 쉽게 구현할 수 있었지만 나머지 케이스(any,all,scalar 등)에서는 너무 큰 복잡도를 가져 오히려 구현후 코드의 복잡도와 유지보수성이 떨어질 수 있다고 생각했다.

그렇다면 모든 케이스에 적용할 수 있다 현실적인 방안은 무엇일까?

### 서브쿼리 테이블 감싸기 (Derived Table)

일단 이것도 결론적으로 적용시키지 않은 이유는 derived table 전체 물리화(materialization) 발생하여 대용량 테이블에서 성능 저하가 일어날 가능성이 있기 때문이다.

### Single-table DELETE / UPDATE 문법 사용 (메인테이너 승인)

내가 제안한 해결책 2가지중 받아들여진 방법이다.

MariaDB의 제약은 multi-table DELETE/UPDATE 문법에 강하게 걸려 있다.
반면, single-table DELETE 에서는 alias 없이 테이블명을 직접 사용하면 correlated subquery가 허용된다.

### 기존 (에러 발생)

```sql
DELETE e
FROM EntityOfBasics e 
WHERE EXISTS (
    SELECT 1
    FROM EntityOfBasics e2
    WHERE e2.theInteger > e.theInteger
);
```


### 수정 후 (MariaDB 10.x에서 정상 동작)

```sql
DELETE FROM EntityOfBasics
WHERE EXISTS (
    SELECT 1
    FROM EntityOfBasics e2
    WHERE e2.theInteger > EntityOfBasics.theInteger
);
```

### 왜 이 방식은 되는가?

* single-table DELETE 문법 사용
* DELETE 대상 테이블에 alias 사용 안 함
* 테이블명으로 직접 상관 참조
* MariaDB 10.x에서 완전히 지원되는 문법

구현은 크게 어렵지 않았다 ast visitor패턴이기 때문에 특정 쿼리문에 도달했을 시

```sql
if ( getDialect().getVersion().isBefore( 11, 1 )
            && statement.getFromClause().getRoots().isEmpty() )
```

로 버전을 확인 후 single-table로 만들어 주면 된다.
